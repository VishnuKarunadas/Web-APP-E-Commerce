<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Nike</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="keywords" content="Goggles a Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template, 
    Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design" />
    <script>
        addEventListener("load", function () {
            setTimeout(hideURLbar, 0);
        }, false);

        function hideURLbar() {
            window.scrollTo(0, 1);
        }
    </script>

</head>

<body>
    <div class="banner-top container-fluid" id="home">
        <%-include("../../views/partials/user/header")%>
    </div>
    <!-- banner -->
    <div class="banner_inner">
        <div class="services-breadcrumb">
            <div class="inner_breadcrumb">
                <ul class="short">
                    <li>
                        <a href="/home">Home</a>
                        <i>|</i>
                    </li>
                    <li>Payment </li>
                </ul>
            </div>
        </div>
    </div>
   
    <section class="banner-bottom-wthreelayouts py-lg-5 py-3">
        <div class="container">
            <div class="inner-sec-shop px-lg-4 px-3">
                <h3 class="tittle-w3layouts my-lg-4 mt-3">Payment </h3>
                <div class="responsive_tabs">
                    <div id="horizontalTab">
                       
                        <div class="resp-tabs-container">
                            <form action="/cart/place-order/make-payment/confirm-order" method="POST" id="orderForm">
                                <input type="hidden" name="userId" value="<%= user._id %>">
                                <input type="hidden" name="address" id="addressInput" value='<%= JSON.stringify(address) %>'>
                                <input type="hidden" name="totalPrice" id="hiddenTotalPrice" value="<%= totalPrice %>">
                                <input type="hidden" name="finalTotal" id="hiddenFinalTotal" value="<%= finalTotal %>">
                                <input type="hidden" name="appliedCouponId" id="appliedCouponId" value="<%= appliedCoupon ? appliedCoupon._id : '' %>">
                                <input type="hidden" name="discountAmount" id="discountAmount" value="<%= discountAmount %>">
                                <input type="hidden" name="couponDiscountAmount" id="couponDiscountAmount" value="<%=  couponDiscountAmount %>">
                                <input type="hidden" name="paymentMethod" id="paymentMethod" value="COD">
                               
                                <% items.forEach(item => { %>
                                    <input type="hidden" name="items[]" value='<%= JSON.stringify(item) %>' />
                                <% }) %>
                            
                        
                            
                                <label style="font-size: x-large;">
                                    <input  type="radio" name="paymentMethodRadio" value="COD" onclick="setPaymentMethod('COD')" checked>
                                    Cash on Delivery
                                </label>
                            
                                <label style="font-size: x-large;">
                                    <input type="radio" name="paymentMethodRadio" value="OnlinePayment" onclick="setPaymentMethod('OnlinePayment')">
                                    Pay Online (Razorpay)
                                </label>

                                <label style="font-size: x-large;">
                                    <input type="radio" name="paymentMethodRadio" value="WalletPayment" onclick="setPaymentMethod('WalletPayment')">
                                    Pay from Wallet
                                </label>
                            <br><br><br>
                                <button class="btn btn-success" type="submit" id="confirmOrderBtn">Confirm Order</button>
                            </form>
                            <div id="responseMessage" style="margin-top: 20px; color: red;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Include the JavaScript file -->
    <!-- <script src="/js/checkout.js"></script> -->

    <%-include("../../views/partials/user/footer")%>
    <!--jQuery-->
    <script src="/js/jquery-2.2.3.min.js"></script>
    <!-- newsletter modal -->
    <!--search jQuery-->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <script src="/js/classie-search.js"></script>
    <script src="/js/demo1-search.js"></script>
    <!--//search jQuery-->
    <!-- cart-js -->
    <script src="/js/minicart.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
     function setPaymentMethod(method) {
    document.getElementById('paymentMethod').value = method;
}


document.getElementById('paymentForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const formData = new FormData(this);
    const orderId = formData.get('orderId');
    const paymentMethod = formData.get('paymentMethod');

    const responseMessage = document.getElementById('responseMessage');
    responseMessage.style.color = 'red'; // Default color for errors

    // If Razorpay is selected as the payment method
    if (paymentMethod === 'Razorpay') {
        try {
            // Fetch Razorpay order details from the backend
            const razorpayOrderResponse = await fetch('/user/payment/razorpay-checkout', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // For passing authentication cookies if necessary
            });

            const razorpayOrderData = await razorpayOrderResponse.json();

            if (!razorpayOrderData.success) {
                responseMessage.textContent = "Failed to initialize Razorpay checkout. Please try again.";
                return;
            }

            // Initialize Razorpay checkout
            const razorpayOptions = {
                key: razorpayOrderData.razorpayKeyId,
                amount: razorpayOrderData.amount,
                currency: 'INR',
                name: 'Your Store Name',
                description: 'Payment for your order',
                order_id: razorpayOrderData.razorpayOrderId,
                handler: async function (response) {
                    try {
                        // Send payment verification data to the backend
                        const verifyResponse = await fetch('/verify-razorpay-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(response),
                            credentials: 'include', // Pass authentication data if required
                        });

                        const verifyData = await verifyResponse.json();

                        if (verifyData.success) {
                            responseMessage.style.color = 'green';
                            responseMessage.textContent = "Payment successful! Your order has been placed.";
                            setTimeout(() => window.location.href = `/order/success/${verifyData.orderId}`, 3000);
                        } else {
                            responseMessage.textContent = verifyData.message || "Payment verification failed.";
                        }
                    } catch (error) {
                        responseMessage.textContent = "Error verifying payment. Please contact support.";
                    }
                },
                prefill: {
                    name: formData.get('userName'),
                    email: formData.get('userEmail'),
                    contact: formData.get('userContact'),
                },
                theme: { color: '#528FF0' },
            };

            const rzp = new Razorpay(razorpayOptions);
            rzp.open();
        } catch (error) {
            responseMessage.textContent = "Error initializing Razorpay checkout. Please try again later.";
        }
        return; // Prevent the form from being submitted for Razorpay
    }

    // Fallback for other payment methods
    this.submit();
});
</script>

      
      



</body>

</html>

	
	// 	
	// 	<script src="/js/easy-responsive-tabs.js"></script>
	// 	
	// 	<!-- credit-card -->
	// 	<script type="/text/javascript" src="/js/creditly.js"></script>
	// 

	// 	<script type="/text/javascript"></script>
	// 	
	// 	<script src="/js/move-top.js"></script>
    // <script src="/js/easing.js"></script>
    /
    /
		<script src="/js/bootstrap.js"></script>
		<!-- js file -->


